---
title: "LierneGreening"
author: "Markus Fjellstad Israelsen"
date: "9 2 2022"
output: html_document
editor_options: 
  chunk_output_type: console
---

Load library
```{r}

library(EBImage)
library(countcolors)
library(camtrapR)
library(lubridate)
library(ggplot2)
library(dplyr)
library(writexl)
library(readxl)

```

Set up Green Fraction function
```{r Green Fraction function, echo = TRUE, eval = TRUE}

# YearlyFolderDir = "P:/12179000_lirypetelemetri_i_lierne/ImagesGreenFraction/"
GreenFraction = function(YearlyFolderDir){
  # Import exif tool
  exiftool_dir = "C:/Exiftool/"        
  exiftoolPath(exiftoolDir = exiftool_dir)
  
  # Define the directory for the image folders
  yearFoldersPath = YearlyFolderDir
  yearFoldersLength = list.files(yearFoldersPath)
  
  # For loop over the years
  for(i in 1:length(yearFoldersLength)){
    memCardFolders = list.files(paste0(yearFoldersPath, yearFoldersLength[i]))
    
    # For loop over the memory cards in each year
    for(j in 1:length(memCardFolders)){
      images = list.files(paste0(yearFoldersPath, yearFoldersLength[i], "/", memCardFolders[j]))
      imagePath = paste0(yearFoldersPath, yearFoldersLength[i], "/", memCardFolders[j])
      MemCard = substring(imagePath, 76, nchar(imagePath))
      
      # For loop over each image, in each memory card, in each year
      imgDay = c()
      imgDayDF = data.frame("Date" = c(ymd("1970-01-01")), "Time" = "09:00:00", GreenFraction = c(NA))
      for (k in 1:length(images)){
        imgDateTime = exifTagNames(inDir = imagePath, 1, images[k])[5, 3]
        Date = substring(imgDateTime, 1, 10)
        sTime = substring(imgDateTime, 20, 22) # correcting for summer time
        aTime = substring(imgDateTime, 12, 19)
        nTime = paste0(as.numeric(substring(aTime, 1, 2))+as.numeric(sTime), substring(aTime, 3, 8))
        Time = ifelse(nchar(nTime) == 7, paste0("0",as.numeric(substring(aTime, 1, 2))+as.numeric(sTime), substring(aTime, 3, 8)), nTime)
        
        if(Time > "06:00:00" & Time < "18:00:00"){
          imgDay = append(imgDay, images[k])
          imgDayDF = rbind(imgDayDF, c(as.character(ymd(Date)), Time, NA))
        }
      }
      imgDayDF = imgDayDF[-1, ]
      
      # For loop that extracts the fraction of green in each image
      for(h in 1:length(imgDay)){
    recImgGreenFraction = countcolors::rectangularRange(jpeg::readJPEG(paste0(imagePath, "/", imgDay[h])), upper = c(0.60, 1, 0.4), lower = c(0, 0.4, 0), color.pixels = FALSE, plotting = FALSE)
    recIGF = recImgGreenFraction$img.fraction * 100
    imgDayDF$GreenFraction[h] = recIGF
      }
      
      # Subset data frame based observations from just the whole hour (for instance, 12:00:00, 13:00:00 and so on.)
      imgDayDF = imgDayDF[grep(":00:00", imgDayDF$Time), ] 
      imgDayDF$GreenFraction = as.numeric(imgDayDF$GreenFraction)
      
      # Take the mean of the green fraction for each day
      imgDayDfMean = imgDayDF %>% group_by(Date) %>% summarise(DailyGreenFraction = mean(GreenFraction, na.rm = TRUE))
      imgDayDfMean = imgDayDfMean %>% mutate(MemCard = MemCard)
      
      # Export excel tables
      write_xlsx(imgDayDfMean, paste0("C:/Users/markus.israelsen/OneDrive - NINA/GitHub/LierneGreening/LierneGreening/Output/", "dailyMean_", substring(yearFoldersLength[i], 14, 17), "_", substring(imagePath, 76, 89), ".xlsx"))
    }
  }
}

```

Run the Greening Fraction Function
```{r Run GF function, echo = TRUE, eval = FALSE}

# Supply the function with the directory path where the yearly greening images are stored (Kamerabilder 2019, Kamerabilder 2020..)
GreenFraction(YearlyFolderDir = "P:/12179000_lirypetelemetri_i_lierne/ImagesGreenFraction/")

```

Import all the green fraction datasets and join them
```{r Import DF, echo = TRUE, eval = FALSE}

outputPath = "C:/Users/markus.israelsen/OneDrive - NINA/GitHub/LierneGreening/LierneGreening/Output/"

greenFractionFiles = list.files(outputPath, pattern = "\\.xlsx$")
greenFractionList = lapply(paste0(outputPath, greenFractionFiles), read_excel)
greenFractionDF = bind_rows(greenFractionList, .id = "id")

```

Plot some of the results
```{r, echo = TRUE, eval = FALSE}

# Plot some of the results

```





































