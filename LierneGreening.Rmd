---
title: "LierneGreening"
author: "Markus Fjellstad Israelsen"
date: "9 2 2022"
output: html_document
editor_options: 
  chunk_output_type: console
---

To do list:
  1. Remove all the images that are not during the day. We could probably only include images taken between 11:00 -     15:00 to make sure we only use images with enough light and it takes a "long" time for a change in "greenness" to     occur. 

```{r}

library(EBImage)
library(countcolors)
library(camtrapR)
library(lubridate)
library(ggplot2)
library(dplyr)
library(writexl)
library(readxl)

```

Load test images
```{r, echo = TRUE, eval = TRUE}

imagePath = "C:/Users/markus.israelsen/OneDrive - NINA/GitHub/LierneGreening/TestImages/RypeLierne0017_2021/101RECNX/"
images = list.files(imagePath)

exiftool_dir = "C:/Exiftool/"        
exiftoolPath(exiftoolDir = exiftool_dir)

start = Sys.time()
imgDay = c()
imgDayDF = data.frame("Date" = c(ymd("2020-01-01")), "Time" = c("09:00:00"), GreenFraction = c(NA))
processBar = 0
for (i in 1:length(images)){
  imgDateTime = exifTagNames(inDir = imagePath, 1, images[i])[5, 3]
  Date = substring(imgDateTime, 1, 10)
  Time = substring(imgDateTime, 12, 19)
  processBar = round(i/length(images), digits = 4)
  print(paste(processBar,"% completed"))
  if(Time > "09:00:00" & Time < "15:00:00"){
    imgDay = append(imgDay, images[i])
    imgDayDF = rbind(imgDayDF, c(as.character(ymd(Date)), Time, NA))
  }
}
end = Sys.time()
end - start

imgDayDF = imgDayDF[-1, ]

```

Counting the pixels using a spherical range. Pick a mid green color and include all colors in a radius from that color. 
```{r, echo = TRUE, eval = TRUE}

i1.spherical = countcolors::sphericalRange(i1, center = c(0.38, 0.55, 0.17), radius = 0.10, color.pixels = FALSE, plotting = FALSE)

i2.spherical = countcolors::sphericalRange(i2, center = c(0.38, 0.55, 0.17), radius = 0.10, color.pixels = FALSE, plotting = FALSE)

i3.spherical = countcolors::sphericalRange(i3, center = c(0.38, 0.55, 0.17), radius = 0.10, color.pixels = FALSE, plotting = FALSE)

i4.spherical = countcolors::sphericalRange(i4, center = c(0.38, 0.55, 0.17), radius = 0.10, color.pixels = FALSE, plotting = FALSE)

i5.spherical = countcolors::sphericalRange(i5, center = c(0.38, 0.55, 0.17), radius = 0.10, color.pixels = FALSE, plotting = FALSE)

i6.spherical = countcolors::sphericalRange(i6, center = c(0.38, 0.55, 0.17), radius = 0.10, color.pixels = FALSE, plotting = FALSE)

i7.spherical = countcolors::sphericalRange(i7, center = c(0.38, 0.55, 0.17), radius = 0.10, color.pixels = FALSE, plotting = FALSE)


# Check if we have to increase/decrease the radius
#countcolors::changePixelColor(i7, i7.spherical$pixel.idx, target.color = "magenta")

# Should change the radius to 12%
countcolors::sphericalRange(i7, center = c(0.38, 0.55, 0.17), radius = 12, color.pixels = FALSE, plotting = TRUE, target.color = "magenta")

# Change the radius to 12%
i1.sph = countcolors::sphericalRange(i1, center = c(0.38, 0.55, 0.17), radius = 0.12, color.pixels = FALSE, plotting = FALSE)

i2.sph = countcolors::sphericalRange(i2, center = c(0.38, 0.55, 0.17), radius = 0.12, color.pixels = FALSE, plotting = FALSE)

i3.sph = countcolors::sphericalRange(i3, center = c(0.38, 0.55, 0.17), radius = 0.12, color.pixels = FALSE, plotting = FALSE)

i4.sph = countcolors::sphericalRange(i4, center = c(0.38, 0.55, 0.17), radius = 0.12, color.pixels = FALSE, plotting = FALSE)

i5.sph = countcolors::sphericalRange(i5, center = c(0.38, 0.55, 0.17), radius = 0.12, color.pixels = FALSE, plotting = FALSE)

i6.sph = countcolors::sphericalRange(i6, center = c(0.38, 0.55, 0.17), radius = 0.12, color.pixels = FALSE, plotting = FALSE)

i7.sph = countcolors::sphericalRange(i7, center = c(0.38, 0.55, 0.17), radius = 0.12, color.pixels = FALSE, plotting = FALSE)

# Extract the percentage covarage of green
i1.sph$img.fraction * 100
i2.sph$img.fraction * 100
i3.sph$img.fraction * 100
i4.sph$img.fraction * 100
i5.sph$img.fraction * 100
i6.sph$img.fraction * 100
i7.sph$img.fraction * 100

```

Run through all the images using spherical ranges.
```{r, echo = TRUE, eval = FALSE}

RL0017Path2020 = "C:/Users/markus.israelsen/OneDrive - NINA/GitHub/LierneGreening/TestImages/"

greenFraction = c()
for(i in 1:length(imgDay)){
  imgGreenFraction = countcolors::sphericalRange(jpeg::readJPEG(paste0(RL0017Path2020, imgDay[i])), center = c(0.38, 0.55, 0.17), radius = 0.12, color.pixels = FALSE, plotting = FALSE)
  igf = imgGreenFraction$img.fraction * 100
  greenFraction = append(greenFraction, igf)
}

```

Run through all the images Using rectangular ranges instead of spherical ranges. Set a range of RGB values that will be included (seems to work really well).
```{r, echo = TRUE, eval = FALSE}

# Set the image path to a variable that shows the information about memory card and year
RL0017Path2020 = "C:/Users/markus.israelsen/OneDrive - NINA/GitHub/LierneGreening/TestImages/"
RL0017Path2021 = "C:/Users/markus.israelsen/OneDrive - NINA/GitHub/LierneGreening/TestImages/RypeLierne0017_2021/101RECNX/"

# For loop that extracts the fraction of green in each image
s2 = Sys.time()
#recGreenFraction = c()
for(i in 1:length(imgDay)){
  recImgGreenFraction = countcolors::rectangularRange(jpeg::readJPEG(paste0(RL0017Path2021, imgDay[i])), upper = c(0.60, 1, 0.4), lower = c(0, 0.4, 0), color.pixels = FALSE, plotting = FALSE)
  recIGF = recImgGreenFraction$img.fraction * 100
  imgDayDF$GreenFraction[i] = recIGF
  #recGreenFraction = append(recGreenFraction, recIGF)
}
e2 = Sys.time()
e2 - s2

# Subset data frame based observations from just the whole hour (for instance, 12:00:00, 13:00:00 and so on.)
copy = imgDayDF
imgDayDF = imgDayDF[grep(":00:00", imgDayDF$Time), ]
imgDayDF$GreenFraction = as.numeric(imgDayDF$GreenFraction)

imgDayDFmed = imgDayDF %>% group_by(Date) %>% summarise(DailyGreenFraction = median(GreenFraction, na.rm = TRUE))
imgDayDFmean = imgDayDF %>% group_by(Date) %>% summarise(DailyGreenFraction = mean(GreenFraction, na.rm = TRUE))
imgDayDFmax = imgDayDF %>% group_by(Date) %>% summarise(DailyGreenFraction = max(GreenFraction, na.rm = TRUE))

imgDayAll = imgDayDFmed %>% mutate(dGreenFracMean = imgDayDFmean$DailyGreenFraction, dGreenFracMax = imgDayDFmax$DailyGreenFraction) %>% rename(dGreenFracMed = DailyGreenFraction)

# Export excel tables
write_xlsx(imgDayDF, "C:/Users/markus.israelsen/OneDrive - NINA/GitHub/LierneGreening/LierneGreening/Output/RypeLierne0017_DF.xlsx")
write_xlsx(imgDayAll, "C:/Users/markus.israelsen/OneDrive - NINA/GitHub/LierneGreening/LierneGreening/Output/RypeLierne0017_2021_All.xlsx")

# Plot some of the results
ggplot(data = imgDayDFmed, aes(x = Date, y = DailyGreenFraction, group = 1)) + geom_line(color = "dark green", size = 1.1) + labs(x = "Date", y = "Fraction of 'green' pixels (%)")

ggplot(data = imgDayDFmean, aes(x = Date, y = DailyGreenFraction, group = 1)) + geom_line(color = "dark green", size = 1.1) + labs(x = "Date", y = "Mean Fraction of 'Green' Pixels (%)")

ggplot(data = imgDayDFmax, aes(x = Date, y = DailyGreenFraction, group = 1)) + geom_line(color = "dark green", size = 1.1) + labs(x = "Date", y = "Fraction of 'green' pixels (%)")


ggplot(data = imgDayAll, aes(x = Date)) + 
  geom_line(aes(y = dGreenFracMean), color = "dark green", size = 1.1) +
  geom_line(aes(y = dGreenFracMed), color = "steelblue", size = 1.1) +
  geom_line(aes(y = dGreenFracMax), color = "maroon", size = 1.1) +
  labs(x = "Date", y = "Fraction of 'green' pixels (%)")

rl0017_2020 = read_xlsx("C:/Users/markus.israelsen/OneDrive - NINA/GitHub/LierneGreening/LierneGreening/Output/RypeLierne0017_2020_All.xlsx")

rl0017_2020 = rl0017_2020 %>% mutate(Year = 2020)
imgDayAll = imgDayAll %>% mutate(Year = 2021)

imgDayBoth = rbind(rl0017_2020, imgDayAll)
imgDayBoth = imgDayBoth %>% mutate(yearDay = yday(Date))
imgDayBoth$Year = as.character(imgDayBoth$Year)

ggplot(data = imgDayBoth, aes(x = yearDay, y = dGreenFracMean)) + 
  geom_line(aes(color = Year, linetype = Year))+
  scale_color_manual(values = c("darkred", "steelblue"))+
  labs(x = "Year Day", y = "Fraction of 'green' pixels (%)")+
  ggtitle("RypeLierne0017")

```







































