---
title: "LierneGreening"
author: "Markus Fjellstad Israelsen"
date: "9 2 2022"
output: html_document
editor_options: 
  chunk_output_type: console
---

To do list:
  1. Remove all the images that are not during the day. We could probably only include images taken between 11:00 -     15:00 to make sure we only use images with enough light and it takes a "long" time for a change in "greenness" to     occur. 

```{r}

library(EBImage)
library(countcolors)
library(camtrapR)
library(lubridate)
library(ggplot2)
library(dplyr)
library(writexl)
library(readxl)

```

Load test images
```{r, echo = TRUE, eval = TRUE}

# Import exif tool
exiftool_dir = "C:/Exiftool/"        
exiftoolPath(exiftoolDir = exiftool_dir)

# Define the directory for the image folders
yearFoldersPath = "P:/12179000_lirypetelemetri_i_lierne/ImagesGreenFraction/"
yearFoldersLength = list.files(yearFoldersPath)

# For loop over the years
for(i in 1:length(yearFoldersLength)){
  memCardFolders = list.files(paste0(yearFoldersPath, yearFoldersLength[i]))
  
  # For loop over the memory cards in each year
  for(j in 1:length(memCardFolders)){
    images = list.files(paste0(yearFoldersPath, yearFoldersLength[i], "/", memCardFolders[j]))
    imagePath = paste0(yearFoldersPath, yearFoldersLength[i], "/", memCardFolders[j])
    
    # For loop over each image, in each memory card, in each year
    imgDay = c()
    imgDayDF = data.frame("Date" = c(ymd("1970-01-01")), "Time" = c("09:00:00"), GreenFraction = c(NA))
    for (k in 1:length(images)){
      imgDateTime = exifTagNames(inDir = imagePath, 1, images[k])[5, 3]
      Date = substring(imgDateTime, 1, 10)
      sTime = substring(imgDateTime, 20, 22) # correcting for summer time
      aTime = substring(imgDateTime, 12, 19)
      Time = paste0(as.numeric(substring(aTime, 1, 2))+as.numeric(sTime), substring(aTime, 3, 8)) 
        
      if(Time > "06:00:00" & Time < "18:00:00"){
        imgDay = append(imgDay, images[k])
        imgDayDF = rbind(imgDayDF, c(as.character(ymd(Date)), Time, NA))
      }
    }
    imgDayDF = imgDayDF[-1, ]
    
    # For loop that extracts the fraction of green in each image
    for(h in 1:length(imgDay)){
  recImgGreenFraction = countcolors::rectangularRange(jpeg::readJPEG(paste0(imagePath, "/", imgDay[h])), upper = c(0.60, 1, 0.4), lower = c(0, 0.4, 0), color.pixels = FALSE, plotting = FALSE)
  recIGF = recImgGreenFraction$img.fraction * 100
  imgDayDF$GreenFraction[h] = recIGF
    }
    
    # Subset data frame based observations from just the whole hour (for instance, 12:00:00, 13:00:00 and so on.)
    imgDayDF = imgDayDF[grep(":00:00", imgDayDF$Time), ] 
    imgDayDF$GreenFraction = as.numeric(imgDayDF$GreenFraction)
    
    # Take the mean of the green fraction for each day
    imgDayDfMean = imgDayDF %>% group_by(Date) %>% summarise(DailyGreenFraction = mean(GreenFraction, na.rm = TRUE))
    
    # Export excel tables
    write_xlsx(imgDayDfMean, paste0("C:/Users/markus.israelsen/OneDrive - NINA/GitHub/LierneGreening/LierneGreening/Output/", "dailyMean_", substring(yearFoldersLength[i], 14, 17), "_", substring(imagePath, 76, 89), ".xlsx"))
  }
}


```

Counting the pixels using a spherical range. Pick a mid green color and include all colors in a radius from that color. 
```{r, echo = TRUE, eval = TRUE}

i1.spherical = countcolors::sphericalRange(i1, center = c(0.38, 0.55, 0.17), radius = 0.10, color.pixels = FALSE, plotting = FALSE)

i2.spherical = countcolors::sphericalRange(i2, center = c(0.38, 0.55, 0.17), radius = 0.10, color.pixels = FALSE, plotting = FALSE)

i3.spherical = countcolors::sphericalRange(i3, center = c(0.38, 0.55, 0.17), radius = 0.10, color.pixels = FALSE, plotting = FALSE)

i4.spherical = countcolors::sphericalRange(i4, center = c(0.38, 0.55, 0.17), radius = 0.10, color.pixels = FALSE, plotting = FALSE)

i5.spherical = countcolors::sphericalRange(i5, center = c(0.38, 0.55, 0.17), radius = 0.10, color.pixels = FALSE, plotting = FALSE)

i6.spherical = countcolors::sphericalRange(i6, center = c(0.38, 0.55, 0.17), radius = 0.10, color.pixels = FALSE, plotting = FALSE)

i7.spherical = countcolors::sphericalRange(i7, center = c(0.38, 0.55, 0.17), radius = 0.10, color.pixels = FALSE, plotting = FALSE)


# Check if we have to increase/decrease the radius
#countcolors::changePixelColor(i7, i7.spherical$pixel.idx, target.color = "magenta")

# Should change the radius to 12%
countcolors::sphericalRange(i7, center = c(0.38, 0.55, 0.17), radius = 12, color.pixels = FALSE, plotting = TRUE, target.color = "magenta")

# Change the radius to 12%
i1.sph = countcolors::sphericalRange(i1, center = c(0.38, 0.55, 0.17), radius = 0.12, color.pixels = FALSE, plotting = FALSE)

i2.sph = countcolors::sphericalRange(i2, center = c(0.38, 0.55, 0.17), radius = 0.12, color.pixels = FALSE, plotting = FALSE)

i3.sph = countcolors::sphericalRange(i3, center = c(0.38, 0.55, 0.17), radius = 0.12, color.pixels = FALSE, plotting = FALSE)

i4.sph = countcolors::sphericalRange(i4, center = c(0.38, 0.55, 0.17), radius = 0.12, color.pixels = FALSE, plotting = FALSE)

i5.sph = countcolors::sphericalRange(i5, center = c(0.38, 0.55, 0.17), radius = 0.12, color.pixels = FALSE, plotting = FALSE)

i6.sph = countcolors::sphericalRange(i6, center = c(0.38, 0.55, 0.17), radius = 0.12, color.pixels = FALSE, plotting = FALSE)

i7.sph = countcolors::sphericalRange(i7, center = c(0.38, 0.55, 0.17), radius = 0.12, color.pixels = FALSE, plotting = FALSE)

# Extract the percentage covarage of green
i1.sph$img.fraction * 100
i2.sph$img.fraction * 100
i3.sph$img.fraction * 100
i4.sph$img.fraction * 100
i5.sph$img.fraction * 100
i6.sph$img.fraction * 100
i7.sph$img.fraction * 100

```

Run through all the images using spherical ranges.
```{r, echo = TRUE, eval = FALSE}

RL0017Path2020 = "C:/Users/markus.israelsen/OneDrive - NINA/GitHub/LierneGreening/TestImages/"

greenFraction = c()
for(i in 1:length(imgDay)){
  imgGreenFraction = countcolors::sphericalRange(jpeg::readJPEG(paste0(RL0017Path2020, imgDay[i])), center = c(0.38, 0.55, 0.17), radius = 0.12, color.pixels = FALSE, plotting = FALSE)
  igf = imgGreenFraction$img.fraction * 100
  greenFraction = append(greenFraction, igf)
}

```

Run through all the images Using rectangular ranges instead of spherical ranges. Set a range of RGB values that will be included (seems to work really well).
```{r, echo = TRUE, eval = FALSE}

imgDayDFmed = imgDayDF %>% group_by(Date) %>% summarise(DailyGreenFraction = median(GreenFraction, na.rm = TRUE))

imgDayDFmax = imgDayDF %>% group_by(Date) %>% summarise(DailyGreenFraction = max(GreenFraction, na.rm = TRUE))

imgDayAll = imgDayDFmed %>% mutate(dGreenFracMean = imgDayDFmean$DailyGreenFraction, dGreenFracMax = imgDayDFmax$DailyGreenFraction) %>% rename(dGreenFracMed = DailyGreenFraction)


# Plot some of the results
ggplot(data = imgDayDFmed, aes(x = Date, y = DailyGreenFraction, group = 1)) + geom_line(color = "dark green", size = 1.1) + labs(x = "Date", y = "Fraction of 'green' pixels (%)")

ggplot(data = imgDayDFmean, aes(x = Date, y = DailyGreenFraction, group = 1)) + geom_line(color = "dark green", size = 1.1) + labs(x = "Date", y = "Mean Fraction of 'Green' Pixels (%)")

ggplot(data = imgDayDFmax, aes(x = Date, y = DailyGreenFraction, group = 1)) + geom_line(color = "dark green", size = 1.1) + labs(x = "Date", y = "Fraction of 'green' pixels (%)")


ggplot(data = imgDayAll, aes(x = Date)) + 
  geom_line(aes(y = dGreenFracMean), color = "dark green", size = 1.1) +
  geom_line(aes(y = dGreenFracMed), color = "steelblue", size = 1.1) +
  geom_line(aes(y = dGreenFracMax), color = "maroon", size = 1.1) +
  labs(x = "Date", y = "Fraction of 'green' pixels (%)")

rl0017_2020 = read_xlsx("C:/Users/markus.israelsen/OneDrive - NINA/GitHub/LierneGreening/LierneGreening/Output/RypeLierne0017_2020_All.xlsx")

rl0017_2020 = rl0017_2020 %>% mutate(Year = 2020)
imgDayAll = imgDayAll %>% mutate(Year = 2021)

imgDayBoth = rbind(rl0017_2020, imgDayAll)
imgDayBoth = imgDayBoth %>% mutate(yearDay = yday(Date))
imgDayBoth$Year = as.character(imgDayBoth$Year)

ggplot(data = imgDayBoth, aes(x = yearDay, y = dGreenFracMean)) + 
  geom_line(aes(color = Year, linetype = Year))+
  scale_color_manual(values = c("darkred", "steelblue"))+
  labs(x = "Year Day", y = "Fraction of 'green' pixels (%)")+
  ggtitle("RypeLierne0017")

```







































